<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIM-RD • Monitoring Dashboard (Prototype)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#121b2e;
      --panel2:#0f172a;
      --text:#e6e9f2;
      --muted:#9aa4b2;
      --line:#22304e;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#60a5fa;
      --chip:#1b2a4a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(900px 600px at 20% 10%, rgba(96,165,250,.15), transparent 55%),
                  radial-gradient(900px 600px at 70% 20%, rgba(245,158,11,.12), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;background: rgba(18,27,46,.72);
      border:1px solid rgba(34,48,78,.9);border-radius: var(--radius);
      box-shadow: var(--shadow); backdrop-filter: blur(10px);
      position: sticky; top: 12px; z-index: 10;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(239,68,68,.85));
      box-shadow: 0 10px 25px rgba(96,165,250,.12);
      display:grid;place-items:center;font-weight:700;
    }
    .brand h1{font-size:15px;margin:0}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .top-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background: rgba(15,23,42,.85);
      border:1px solid rgba(34,48,78,.9);
      color: var(--muted); font-size:12px;
    }
    .btn{
      border:1px solid rgba(34,48,78,.9);
      background: rgba(15,23,42,.85);
      color: var(--text);
      padding:9px 12px;border-radius:12px;
      cursor:pointer; font-size:12px;
    }
    .btn:hover{border-color: rgba(96,165,250,.8)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(96,165,250,.55));
      border-color: rgba(96,165,250,.9);
      color:#06101f;
      font-weight:700;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      header{position:static}
    }
    .card{
      background: rgba(18,27,46,.72);
      border:1px solid rgba(34,48,78,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card-h{
      padding:12px 14px;
      border-bottom:1px solid rgba(34,48,78,.8);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card-h h2{margin:0;font-size:13px}
    .card-b{padding:12px 14px}
    .kpi-row{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 760px){ .kpi-row{grid-template-columns: repeat(2, 1fr);} }
    .kpi{
      background: rgba(15,23,42,.75);
      border:1px solid rgba(34,48,78,.85);
      border-radius: 14px;
      padding:10px 10px;
    }
    .kpi .label{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .kpi .value{font-size:18px;font-weight:800;margin-top:6px}
    .dot{width:9px;height:9px;border-radius:999px;display:inline-block}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .dot.info{background:var(--info)}
    .filters{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .field{
      display:flex;flex-direction:column;gap:6px;
      min-width: 160px;
    }
    label{font-size:11px;color:var(--muted)}
    select,input{
      background: rgba(15,23,42,.85);
      border:1px solid rgba(34,48,78,.9);
      color: var(--text);
      border-radius:12px;
      padding:9px 10px;
      outline:none;
      font-size:12px;
    }
    input::placeholder{color:#78839a}
    .table-wrap{overflow:auto;border-radius:14px;border:1px solid rgba(34,48,78,.8)}
    table{width:100%;border-collapse:collapse;min-width:860px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(34,48,78,.6);font-size:12px;vertical-align:top}
    th{color:var(--muted);text-align:left;background: rgba(15,23,42,.65);position:sticky;top:0}
    tr:hover td{background: rgba(96,165,250,.06)}
    .mono{font-family: var(--mono)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 9px;border-radius:999px;
      background: rgba(27,42,74,.7);
      border:1px solid rgba(34,48,78,.9);
      font-size:11px;
      white-space:nowrap;
    }
    .sev-high{border-color: rgba(239,68,68,.7)}
    .sev-med{border-color: rgba(245,158,11,.7)}
    .sev-low{border-color: rgba(34,197,94,.7)}
    .status-new{border-color: rgba(96,165,250,.7)}
    .status-verified{border-color: rgba(34,197,94,.7)}
    .status-resolved{border-color: rgba(154,164,178,.7); color: var(--muted)}
    .split{
      display:grid; grid-template-columns: 1fr;
      gap:14px;
    }
    .chart{
      height:170px;
      border:1px solid rgba(34,48,78,.85);
      background: rgba(15,23,42,.65);
      border-radius:14px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    canvas{width:100%;height:100%}
    .details{
      display:grid; gap:10px;
    }
    .details .row{
      display:grid; grid-template-columns: 120px 1fr;
      gap:10px; align-items:start;
      padding:10px;
      background: rgba(15,23,42,.65);
      border:1px solid rgba(34,48,78,.85);
      border-radius:14px;
    }
    .details .k{font-size:11px;color:var(--muted)}
    .details .v{font-size:12px;line-height:1.35}
    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:6px;
    }
    .toast{
      position: fixed; right: 16px; bottom: 16px;
      background: rgba(18,27,46,.9);
      border:1px solid rgba(34,48,78,.9);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding:10px 12px;
      font-size:12px;
      color: var(--text);
      opacity:0; transform: translateY(10px);
      transition: all .2s ease;
      max-width: 340px;
      z-index: 99;
    }
    .toast.show{opacity:1; transform: translateY(0)}
    .muted{color:var(--muted)}
    .right-mini{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
      color: var(--muted); font-size:12px;
    }
    .linkish{
      text-decoration: underline; text-underline-offset: 3px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">AI</div>
        <div>
          <h1>AIM-RD • AI Model–Driven Reporting Dashboard</h1>
          <div class="sub">Prototype monitoring UI (simulated data) • last update: <span id="lastUpdate">—</span></div>
        </div>
      </div>
      <div class="top-actions">
        <div class="pill"><span class="dot info"></span><span>Live Feed</span> <span class="mono" id="feedState">ON</span></div>
        <button class="btn" id="toggleFeedBtn">Pause Feed</button>
        <button class="btn primary" id="addReportBtn">+ Add Test Report</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: KPIs + Table -->
      <section class="card">
        <div class="card-h">
          <h2>Situation Overview</h2>
          <div class="right-mini">
            <span class="muted">Region:</span> <span class="badge"><span class="dot info"></span>Municipality A</span>
            <span class="muted">Mode:</span> <span class="badge"><span class="dot warn"></span>Typhoon Monitoring</span>
          </div>
        </div>
        <div class="card-b">
          <div class="kpi-row" id="kpis"></div>

          <div style="height:12px"></div>

          <div class="filters">
            <div class="field">
              <label for="severityFilter">Severity</label>
              <select id="severityFilter">
                <option value="all">All</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>

            <div class="field">
              <label for="statusFilter">Status</label>
              <select id="statusFilter">
                <option value="all">All</option>
                <option value="New">New</option>
                <option value="Verified">Verified</option>
                <option value="Resolved">Resolved</option>
              </select>
            </div>

            <div class="field" style="min-width: 240px;">
              <label for="keyword">Keyword</label>
              <input id="keyword" placeholder="e.g. flood, stranded, medicine, bridge" />
            </div>

            <div class="field">
              <label>&nbsp;</label>
              <button class="btn" id="clearFiltersBtn">Clear</button>
            </div>

            <div class="field">
              <label>&nbsp;</label>
              <button class="btn" id="exportBtn">Export CSV</button>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Severity</th>
                  <th>Status</th>
                  <th>Location</th>
                  <th>Summary</th>
                  <th>Confidence</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div style="height:10px"></div>
          <div class="muted" style="font-size:12px">
            Tip: click a row to view details. This is a UI prototype; replace simulated feed with your API later.
          </div>
        </div>
      </section>

      <!-- RIGHT: Trend + Details -->
      <aside class="split">
        <section class="card">
          <div class="card-h">
            <h2>Reports Trend (last 60 minutes)</h2>
            <div class="right-mini">
              <span class="linkish" id="regenTrend">Rebuild trend</span>
            </div>
          </div>
          <div class="card-b">
            <div class="chart">
              <div class="muted" style="font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
                <span>Incoming reports / 5-min bucket</span>
                <span class="mono" id="trendMeta">—</span>
              </div>
              <canvas id="trendCanvas" width="800" height="280" aria-label="Trend chart"></canvas>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-h">
            <h2>Selected Report</h2>
            <div class="right-mini">
              <span class="badge" id="selId">ID: —</span>
            </div>
          </div>
          <div class="card-b">
            <div class="details" id="details">
              <div class="muted">Select a report from the table.</div>
            </div>
            <div class="actions" id="detailActions" style="display:none">
              <button class="btn" id="markVerifiedBtn">Mark Verified</button>
              <button class="btn" id="markResolvedBtn">Mark Resolved</button>
              <button class="btn" id="copyJsonBtn">Copy JSON</button>
            </div>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // --- Prototype data model ---
    const TYPES = ["Flood", "Landslide", "Stranded", "Medical", "Power Outage", "Road Blocked", "Evacuation", "Food/Water"];
    const BARANGAYS = ["Brgy. San Isidro", "Brgy. Mabini", "Brgy. Poblacion", "Brgy. Maligaya", "Brgy. Sto. Niño", "Brgy. Bagong Silang"];
    const LANDMARKS = ["near bridge", "by school", "at market", "along highway", "behind barangay hall", "near river"];
    const SUMMARIES = [
      "Water rising fast, residents requesting evacuation.",
      "Road blocked by fallen tree, vehicles stuck.",
      "Family stranded on rooftop, needs rescue boat.",
      "Need medicine for elderly, no transport.",
      "Power down since morning, charging stations needed.",
      "Suspected landslide risk, cracks seen on slope."
    ];

    function nowISO(){ return new Date().toISOString(); }
    function minsAgo(m){
      const d = new Date(Date.now() - m*60*1000);
      return d.toISOString();
    }
    function fmtTime(iso){
      const d = new Date(iso);
      return d.toLocaleString([], {hour:'2-digit', minute:'2-digit'}) + " • " +
             d.toLocaleDateString([], {month:'short', day:'2-digit'});
    }
    function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    function severityFromText(type, text){
      // simple heuristic for demo; replace with model output later
      const t = (type + " " + text).toLowerCase();
      if (/(stranded|evac|rescue|roof|rising fast|medical|bleeding|unconscious)/.test(t)) return "High";
      if (/(flood|power|road|blocked|landslide|risk)/.test(t)) return "Medium";
      return "Low";
    }

    function confidenceScore(text){
      // fake "model confidence" score
      const base = 0.62 + Math.random()*0.32;
      const lenBoost = Math.min(text.length/180, 0.10);
      return clamp(base + lenBoost, 0.55, 0.98);
    }

    let reports = seedReports();
    let selectedId = null;
    let feedOn = true;

    function seedReports(){
      const base = [];
      const count = 16;
      for (let i=0;i<count;i++){
        const type = rand(TYPES);
        const summary = rand(SUMMARIES);
        const loc = `${rand(BARANGAYS)} ${rand(LANDMARKS)}`;
        const created_at = minsAgo(55 - i*3);
        const sev = severityFromText(type, summary);
        const conf = confidenceScore(summary);
        base.push({
          id: "R-" + String(1000+i),
          created_at,
          type,
          severity: sev,
          status: i < 4 ? "Resolved" : (i < 8 ? "Verified" : "New"),
          location: loc,
          message: summary + " Caller: 09xx-xxx-xxxx. " + (Math.random() > .6 ? "Photo attached." : "No photo."),
          confidence: conf,
          source: Math.random() > .5 ? "SMS" : "Web Form",
          reporter_name: Math.random() > .7 ? "Anonymous" : "Citizen",
          contact: "09xx-xxx-xxxx",
          tags: buildTags(type, summary),
        });
      }
      return base.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
    }

    function buildTags(type, text){
      const t = (type + " " + text).toLowerCase();
      const tags = [];
      if (t.includes("flood") || t.includes("water")) tags.push("flooding");
      if (t.includes("stranded") || t.includes("rescue")) tags.push("rescue");
      if (t.includes("medical") || t.includes("medicine")) tags.push("medical");
      if (t.includes("road") || t.includes("blocked")) tags.push("access");
      if (t.includes("power")) tags.push("utilities");
      if (t.includes("landslide")) tags.push("landslide");
      return tags.length ? tags : ["general"];
    }

    // --- UI helpers ---
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(()=> el.classList.remove("show"), 1600);
    }

    function sevBadge(sev){
      const cls = sev === "High" ? "sev-high" : sev === "Medium" ? "sev-med" : "sev-low";
      const dot = sev === "High" ? "bad" : sev === "Medium" ? "warn" : "good";
      return `<span class="badge ${cls}"><span class="dot ${dot}"></span>${sev}</span>`;
    }

    function statusBadge(st){
      const cls = st === "New" ? "status-new" : st === "Verified" ? "status-verified" : "status-resolved";
      const dot = st === "New" ? "info" : st === "Verified" ? "good" : "warn";
      return `<span class="badge ${cls}"><span class="dot ${dot}"></span>${st}</span>`;
    }

    function pct(x){ return Math.round(x*100) + "%"; }

    function updateLast(){
      const d = new Date();
      $("lastUpdate").textContent = d.toLocaleString([], {weekday:'short', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    }

    // --- Rendering ---
    function renderKPIs(filtered){
      const total = filtered.length;
      const high = filtered.filter(r=>r.severity==="High").length;
      const med = filtered.filter(r=>r.severity==="Medium").length;
      const low = filtered.filter(r=>r.severity==="Low").length;
      const newCount = filtered.filter(r=>r.status==="New").length;
      const verified = filtered.filter(r=>r.status==="Verified").length;
      const resolved = filtered.filter(r=>r.status==="Resolved").length;
      const avgConf = total ? (filtered.reduce((s,r)=>s+r.confidence,0)/total) : 0;

      const k = [
        {label:"Total reports", value: total, dot:"info"},
        {label:"High severity", value: high, dot:"bad"},
        {label:"New / Pending", value: newCount, dot:"warn"},
        {label:"Avg confidence", value: pct(avgConf), dot:"good"},
      ];

      $("kpis").innerHTML = k.map(x=>`
        <div class="kpi">
          <div class="label"><span class="dot ${x.dot}"></span>${x.label}</div>
          <div class="value">${x.value}</div>
          <div class="muted" style="font-size:11px;margin-top:6px">
            H:${high} • M:${med} • L:${low} • V:${verified} • R:${resolved}
          </div>
        </div>
      `).join("");
    }

    function applyFilters(){
      const sev = $("severityFilter").value;
      const st = $("statusFilter").value;
      const kw = $("keyword").value.trim().toLowerCase();

      let out = reports.slice();
      if (sev !== "all") out = out.filter(r=>r.severity===sev);
      if (st !== "all") out = out.filter(r=>r.status===st);
      if (kw) out = out.filter(r=>{
        const hay = (r.type+" "+r.location+" "+r.message+" "+r.tags.join(" ")).toLowerCase();
        return hay.includes(kw);
      });
      return out;
    }

    function renderTable(rows){
      const tbody = $("tbody");
      tbody.innerHTML = rows.map(r=>`
        <tr data-id="${r.id}" style="cursor:pointer">
          <td class="mono">${fmtTime(r.created_at)}</td>
          <td>${r.type}</td>
          <td>${sevBadge(r.severity)}</td>
          <td>${statusBadge(r.status)}</td>
          <td>${r.location}</td>
          <td>${escapeHtml(r.message).slice(0, 86)}${r.message.length>86?"…":""}</td>
          <td class="mono">${pct(r.confidence)}</td>
        </tr>
      `).join("");

      // row click
      [...tbody.querySelectorAll("tr")].forEach(tr=>{
        tr.addEventListener("click", ()=>{
          selectReport(tr.getAttribute("data-id"));
        });
      });
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function selectReport(id){
      selectedId = id;
      const r = reports.find(x=>x.id===id);
      if (!r) return;

      $("selId").textContent = "ID: " + r.id;

      $("details").innerHTML = `
        <div class="row"><div class="k">Time</div><div class="v mono">${fmtTime(r.created_at)}</div></div>
        <div class="row"><div class="k">Type</div><div class="v">${r.type}</div></div>
        <div class="row"><div class="k">Severity</div><div class="v">${sevBadge(r.severity)}</div></div>
        <div class="row"><div class="k">Status</div><div class="v">${statusBadge(r.status)}</div></div>
        <div class="row"><div class="k">Location</div><div class="v">${r.location}</div></div>
        <div class="row"><div class="k">Source</div><div class="v">${r.source}</div></div>
        <div class="row"><div class="k">Confidence</div><div class="v mono">${pct(r.confidence)}</div></div>
        <div class="row"><div class="k">Tags</div><div class="v">${r.tags.map(t=>`<span class="badge">${t}</span>`).join(" ")}</div></div>
        <div class="row"><div class="k">Message</div><div class="v">${escapeHtml(r.message)}</div></div>
      `;

      $("detailActions").style.display = "flex";
    }

    function rerender(){
      const filtered = applyFilters();
      renderKPIs(filtered);
      renderTable(filtered);
      updateLast();
      renderTrend(); // based on full report stream
    }

    // --- Trend chart (simple canvas line chart) ---
    function buildBuckets(){
      // 60 minutes, 5-min buckets => 12 points
      const buckets = Array.from({length:12}, (_,i)=>({i, count:0}));
      const now = Date.now();
      for (const r of reports){
        const t = new Date(r.created_at).getTime();
        const diffMin = (now - t) / (60*1000);
        if (diffMin < 0 || diffMin > 60) continue;
        const idx = Math.min(11, Math.floor((60 - diffMin) / 5)); // older->smaller
        buckets[idx].count++;
      }
      return buckets.map(b=>b.count);
    }

    function renderTrend(){
      const canvas = $("trendCanvas");
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;

      // clear
      ctx.clearRect(0,0,w,h);

      // grid
      ctx.globalAlpha = 1;
      ctx.lineWidth = 1;
      ctx.strokeStyle = "rgba(34,48,78,.9)";
      for (let i=0;i<=5;i++){
        const y = 20 + i*((h-40)/5);
        ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(w-20,y); ctx.stroke();
      }
      for (let i=0;i<=12;i++){
        const x = 40 + i*((w-60)/12);
        ctx.beginPath(); ctx.moveTo(x,20); ctx.lineTo(x,h-20); ctx.stroke();
      }

      const data = buildBuckets();
      const max = Math.max(3, ...data);
      $("trendMeta").textContent = `max bucket: ${max} • points: ${data.length}`;

      // line
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(96,165,250,.95)";
      ctx.beginPath();
      data.forEach((v, i)=>{
        const x = 40 + i*((w-60)/(data.length-1));
        const y = 20 + (h-40) * (1 - (v/max));
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // points
      ctx.fillStyle = "rgba(245,158,11,.95)";
      data.forEach((v,i)=>{
        const x = 40 + i*((w-60)/(data.length-1));
        const y = 20 + (h-40) * (1 - (v/max));
        ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
      });

      // labels
      ctx.fillStyle = "rgba(154,164,178,.95)";
      ctx.font = "12px ui-monospace, Menlo, Monaco, Consolas, monospace";
      ctx.fillText("60m ago", 40, h-6);
      ctx.fillText("now", w-52, h-6);
      ctx.fillText(String(max), 8, 28);
      ctx.fillText("0", 18, h-22);
    }

    // --- Actions ---
    function addRandomReport(){
      const type = rand(TYPES);
      const msg = rand(SUMMARIES);
      const loc = `${rand(BARANGAYS)} ${rand(LANDMARKS)}`;
      const sev = severityFromText(type, msg);
      const conf = confidenceScore(msg);

      const idNum = 1000 + reports.length + Math.floor(Math.random()*50);
      const r = {
        id: "R-" + idNum,
        created_at: nowISO(),
        type,
        severity: sev,
        status: "New",
        location: loc,
        message: msg + " Reporter notes: heavy rain now.",
        confidence: conf,
        source: Math.random()>.5 ? "SMS" : "Web Form",
        reporter_name: Math.random() > .7 ? "Anonymous" : "Citizen",
        contact: "09xx-xxx-xxxx",
        tags: buildTags(type, msg),
      };
      reports.unshift(r);
      toast(`New report received: ${r.id} • ${r.type} • ${r.severity}`);
      rerender();
    }

    function toggleFeed(){
      feedOn = !feedOn;
      $("feedState").textContent = feedOn ? "ON" : "OFF";
      $("toggleFeedBtn").textContent = feedOn ? "Pause Feed" : "Resume Feed";
      toast(feedOn ? "Live feed resumed" : "Live feed paused");
    }

    function setStatus(newStatus){
      if (!selectedId) return toast("Select a report first");
      const r = reports.find(x=>x.id===selectedId);
      if (!r) return;
      r.status = newStatus;
      toast(`${r.id} set to ${newStatus}`);
      rerender();
      selectReport(r.id);
    }

    function copySelectedJson(){
      if (!selectedId) return toast("Select a report first");
      const r = reports.find(x=>x.id===selectedId);
      if (!r) return;
      navigator.clipboard.writeText(JSON.stringify(r, null, 2))
        .then(()=>toast("Copied JSON to clipboard"))
        .catch(()=>toast("Clipboard blocked by browser"));
    }

    function exportCSV(){
      const filtered = applyFilters();
      const cols = ["id","created_at","type","severity","status","location","confidence","source","tags","message"];
      const rows = filtered.map(r=>cols.map(c=>{
        const v = c==="tags" ? r.tags.join("|") : r[c];
        return `"${String(v).replaceAll('"','""')}"`;
      }).join(","));
      const csv = [cols.join(","), ...rows].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "aim-rd_reports.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported CSV");
    }

    // --- Event wiring ---
    $("severityFilter").addEventListener("change", rerender);
    $("statusFilter").addEventListener("change", rerender);
    $("keyword").addEventListener("input", ()=> {
      // light debounce
      window.clearTimeout(window.__kwT);
      window.__kwT = window.setTimeout(rerender, 150);
    });
    $("clearFiltersBtn").addEventListener("click", ()=>{
      $("severityFilter").value = "all";
      $("statusFilter").value = "all";
      $("keyword").value = "";
      rerender();
      toast("Filters cleared");
    });

    $("addReportBtn").addEventListener("click", addRandomReport);
    $("toggleFeedBtn").addEventListener("click", toggleFeed);
    $("markVerifiedBtn").addEventListener("click", ()=>setStatus("Verified"));
    $("markResolvedBtn").addEventListener("click", ()=>setStatus("Resolved"));
    $("copyJsonBtn").addEventListener("click", copySelectedJson);
    $("exportBtn").addEventListener("click", exportCSV);
    $("regenTrend").addEventListener("click", ()=>{ renderTrend(); toast("Trend rebuilt"); });

    // Simulated live feed
    setInterval(()=>{
      if (!feedOn) return;
      if (Math.random() < 0.35) addRandomReport();
    }, 4500);

    // Initial render
    rerender();
  </script>
</body>
</html>
